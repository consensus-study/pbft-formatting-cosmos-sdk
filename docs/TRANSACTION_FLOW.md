# PBFT-Cosmos íŠ¸ëœì­ì…˜ íë¦„ ì™„ë²½ ê°€ì´ë“œ

## ëª©ì°¨
1. [ì „ì²´ ì•„í‚¤í…ì²˜](#1-ì „ì²´-ì•„í‚¤í…ì²˜)
2. [íŠ¸ëœì­ì…˜ ì œì¶œ íë¦„](#2-íŠ¸ëœì­ì…˜-ì œì¶œ-íë¦„)
3. [ë©¤í’€ ì²˜ë¦¬ íë¦„](#3-ë©¤í’€-ì²˜ë¦¬-íë¦„)
4. [PBFT í•©ì˜ íë¦„](#4-pbft-í•©ì˜-íë¦„)
5. [ABCI 2.0 í†µí•© íë¦„](#5-abci-20-í†µí•©-íë¦„)
6. [ì½”ë“œ ìœ„ì¹˜ ê°€ì´ë“œ](#6-ì½”ë“œ-ìœ„ì¹˜-ê°€ì´ë“œ)

---

## 1. ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    PBFT-COSMOS NODE                                      â”‚
â”‚                                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Client    â”‚     â”‚   Reactor   â”‚     â”‚   Mempool   â”‚     â”‚   Engine    â”‚           â”‚
â”‚  â”‚   (RPC)     â”‚â”€â”€â”€â”€â–ºâ”‚             â”‚â”€â”€â”€â”€â–ºâ”‚             â”‚â”€â”€â”€â”€â–ºâ”‚  (PBFT V2)  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                      â”‚                  â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
â”‚                            â”‚                                         â”‚                  â”‚
â”‚                            â–¼                                         â–¼                  â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                   â”‚  Transport  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    ABCI     â”‚            â”‚
â”‚                   â”‚   (gRPC)    â”‚                           â”‚   Adapter   â”‚            â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                          â”‚                                         â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                                         â”‚
                           â–¼                                         â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   Other     â”‚                           â”‚  Cosmos SDK â”‚
                   â”‚   Nodes     â”‚                           â”‚    App      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ìš” ì»´í¬ë„ŒíŠ¸ ì„¤ëª…

| ì»´í¬ë„ŒíŠ¸ | íŒŒì¼ ìœ„ì¹˜ | ì—­í•  |
|---------|----------|------|
| **Mempool** | `mempool/mempool.go` | íŠ¸ëœì­ì…˜ í’€ ê´€ë¦¬, ìš°ì„ ìˆœìœ„ ì •ë ¬, ì¤‘ë³µ ì œê±° |
| **Reactor** | `mempool/reactor.go` | ë©¤í’€-ë„¤íŠ¸ì›Œí¬ ì—°ê²°, ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| **Engine V2** | `consensus/pbft/engine_v2.go` | PBFT í•©ì˜ ë¡œì§, ABCI 2.0 í†µí•© |
| **ABCI Adapter** | `consensus/pbft/abci_adapter.go` | Cosmos SDK ì•±ê³¼ í†µì‹  |
| **Transport** | `transport/grpc.go` | P2P gRPC í†µì‹  |

---

## 2. íŠ¸ëœì­ì…˜ ì œì¶œ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          íŠ¸ëœì­ì…˜ ì œì¶œ (Client â†’ Mempool)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     Client                Reactor               Mempool                  ABCI App
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚  1. SubmitTx(tx)    â”‚                     â”‚                        â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚                        â”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚                     â”‚  2. AddTxWithMeta() â”‚                        â”‚
        â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                        â”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚                     â”‚                     â”‚  3. ì¤‘ë³µ ì²´í¬          â”‚
        â”‚                     â”‚                     â”‚  (txStore ì¡°íšŒ)        â”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚                     â”‚                     â”‚  4. í¬ê¸° ì²´í¬          â”‚
        â”‚                     â”‚                     â”‚  (MaxTxBytes)          â”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚                     â”‚                     â”‚  5. CheckTx ì½œë°±       â”‚
        â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚                     â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                     â”‚                     â”‚  6. ê²€ì¦ ê²°ê³¼          â”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚                     â”‚                     â”‚  7. ìš©ëŸ‰ ì²´í¬/í‡´ì¶œ     â”‚
        â”‚                     â”‚                     â”‚  (MaxTxs, ë‚®ì€ Gas     â”‚
        â”‚                     â”‚                     â”‚   ìš°ì„  í‡´ì¶œ)           â”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚                     â”‚                     â”‚  8. ì €ì¥               â”‚
        â”‚                     â”‚                     â”‚  - txStore[hash] = tx  â”‚
        â”‚                     â”‚                     â”‚  - senderIndex ê°±ì‹     â”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
        â”‚                     â”‚  9. ì„±ê³µ            â”‚                        â”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚                     â”‚  10. ë¸Œë¡œë“œìºìŠ¤íŠ¸   â”‚                        â”‚
        â”‚                     â”‚  íì— ì¶”ê°€          â”‚                        â”‚
        â”‚                     â”‚                     â”‚                        â”‚
        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                        â”‚
        â”‚  11. ê²°ê³¼ ë°˜í™˜      â”‚                     â”‚                        â”‚
        â”‚                     â”‚                     â”‚                        â”‚
```

### ğŸ“ ê´€ë ¨ ì½”ë“œ

```
mempool/reactor.go:118-135    - SubmitTx(), SubmitTxWithMeta()
mempool/mempool.go:188-254    - AddTx(), AddTxWithMeta()
mempool/mempool.go:257-267    - checkNonce()
mempool/mempool.go:270-290    - ensureCapacity(), evictLowestPriority()
```

---

## 3. ë©¤í’€ ì²˜ë¦¬ íë¦„

### 3.1 ë©¤í’€ ë‚´ë¶€ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    MEMPOOL                                           â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                              txStore (map)                                     â”‚  â”‚
â”‚  â”‚                         [txHash] -> *Tx                                        â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   hash_abc123 â”€â”€â–º Tx{Data, Sender:"alice", Nonce:5, GasPrice:100}             â”‚  â”‚
â”‚  â”‚   hash_def456 â”€â”€â–º Tx{Data, Sender:"bob",   Nonce:3, GasPrice:80}              â”‚  â”‚
â”‚  â”‚   hash_ghi789 â”€â”€â–º Tx{Data, Sender:"alice", Nonce:6, GasPrice:120}             â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                           senderIndex (map)                                    â”‚  â”‚
â”‚  â”‚                       [sender] -> []*Tx (nonce ì •ë ¬)                           â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   "alice" â”€â”€â–º [ Tx{nonce:5}, Tx{nonce:6} ]  // nonce ìˆœì„œ ìœ ì§€                 â”‚  â”‚
â”‚  â”‚   "bob"   â”€â”€â–º [ Tx{nonce:3} ]                                                  â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ReapMaxTxs() - ë¸”ë¡ ì œì•ˆ ì‹œ í˜¸ì¶œ                            â”‚  â”‚
â”‚  â”‚                   (GasPrice ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ ìƒìœ„ Nê°œ ë°˜í™˜)                     â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â”‚   ë†’ì€ ìš°ì„ ìˆœìœ„ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ë‚®ì€ ìš°ì„ ìˆœìœ„          â”‚  â”‚
â”‚  â”‚   [GasPrice:120]  [GasPrice:100]  [GasPrice:80]  ...                          â”‚  â”‚
â”‚  â”‚                                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ë©¤í’€ íŠ¸ëœì­ì…˜ ì¡°íšŒ (ë¸”ë¡ ì œì•ˆ ì‹œ)

```
     Primary Node              Mempool
          â”‚                       â”‚
          â”‚  1. ReapMaxTxs(500)   â”‚  â—„â”€â”€ ìµœëŒ€ 500ê°œ íŠ¸ëœì­ì…˜ ìš”ì²­
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
          â”‚                       â”‚
          â”‚                       â”‚  2. ëª¨ë“  txë¥¼ ìŠ¬ë¼ì´ìŠ¤ë¡œ ë³µì‚¬
          â”‚                       â”‚     txs := []Tx{...}
          â”‚                       â”‚
          â”‚                       â”‚  3. GasPrice ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
          â”‚                       â”‚     sort(txs, by GasPrice)
          â”‚                       â”‚
          â”‚                       â”‚  4. ìƒìœ„ Nê°œ ì„ íƒ
          â”‚                       â”‚     txs = txs[:500]
          â”‚                       â”‚
          â”‚  5. []*Tx ë°˜í™˜        â”‚
          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
          â”‚                       â”‚
```

### ğŸ“ ê´€ë ¨ ì½”ë“œ

```
mempool/mempool.go:70-85      - Mempool êµ¬ì¡°ì²´ ì •ì˜
mempool/mempool.go:324-365    - ReapMaxTxs(), ReapMaxBytes()
mempool/tx.go:1-67            - Tx êµ¬ì¡°ì²´ ì •ì˜
```

---

## 4. PBFT í•©ì˜ íë¦„

### 4.1 ì „ì²´ PBFT íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                PBFT í•©ì˜ ê³¼ì •                                         â”‚
â”‚                                                                                       â”‚
â”‚  ì‹œê°„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
â”‚                                                                                       â”‚
â”‚  Primary   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚
â”‚  (ë¦¬ë”)    â”‚ REQUEST â”‚                                                               â”‚
â”‚            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                               â”‚
â”‚                 â”‚                                                                     â”‚
â”‚                 â–¼                                                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚            â”‚  PRE-PREPARE  â”‚  â—„â”€â”€ ABCI PrepareProposal í˜¸ì¶œ                          â”‚
â”‚            â”‚  (ë¸”ë¡ ì œì•ˆ)   â”‚                                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚                    â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                    â”‚ broadcast                                                        â”‚
â”‚                    â–¼                                                                  â”‚
â”‚  Replica   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚  (ë…¸ë“œë“¤)  â”‚    PREPARE    â”‚  â—„â”€â”€ ABCI ProcessProposal í˜¸ì¶œ (ê²€ì¦)                   â”‚
â”‚            â”‚ (2f+1 í•„ìš”)   â”‚                                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚                    â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                    â”‚ broadcast                                                        â”‚
â”‚                    â–¼                                                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚            â”‚    COMMIT     â”‚                                                         â”‚
â”‚            â”‚ (2f+1 í•„ìš”)   â”‚                                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚                    â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                    â”‚                                                                  â”‚
â”‚                    â–¼                                                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                         â”‚
â”‚            â”‚    EXECUTE    â”‚  â—„â”€â”€ ABCI FinalizeBlock + Commit í˜¸ì¶œ                   â”‚
â”‚            â”‚  (ë¸”ë¡ ì‹¤í–‰)   â”‚                                                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                         â”‚
â”‚                                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4ë…¸ë“œ ê¸°ì¤€: f=1 (ë¹„ì”í‹´ ì¥ì•  í—ˆìš© ìˆ˜)
- ì´ ë…¸ë“œ: 3f+1 = 4
- ì¿¼ëŸ¼(Quorum): 2f+1 = 3 (í•©ì˜ì— í•„ìš”í•œ ìµœì†Œ ë…¸ë“œ ìˆ˜)
```

### 4.2 ìƒì„¸ ë©”ì‹œì§€ íë¦„ (4ë…¸ë“œ ì˜ˆì‹œ)

```
     Node0          Node1          Node2          Node3
   (Primary)      (Replica)      (Replica)      (Replica)
       â”‚              â”‚              â”‚              â”‚
       â”‚              â”‚              â”‚              â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
       â”‚         PRE-PREPARE ë‹¨ê³„                   â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
       â”‚              â”‚              â”‚              â”‚
       â”‚  PRE-PREPARE â”‚              â”‚              â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚              â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚              â”‚              â”‚              â”‚
       â”‚  ProcessProposal (ABCI)    ProcessProposalâ”‚
       â”‚              â”‚              â”‚              â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
       â”‚            PREPARE ë‹¨ê³„                    â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
       â”‚              â”‚              â”‚              â”‚
       â”‚â—„â”€â”€ PREPARE â”€â”€â”‚              â”‚              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ PREPARE â”€â”€â”€â”‚              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ PREPARE â”€â”€â”€â”‚
       â”‚              â”‚              â”‚              â”‚
       â”‚â”€â”€ PREPARE â”€â”€â–ºâ”‚â”€â”€ PREPARE â”€â”€â–ºâ”‚â”€â”€ PREPARE â”€â”€â–ºâ”‚
       â”‚              â”‚              â”‚              â”‚
       â”‚      ê° ë…¸ë“œ: PrepareCount >= 2f+1 (3ê°œ) í™•ì¸          â”‚
       â”‚              â”‚              â”‚              â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
       â”‚            COMMIT ë‹¨ê³„                     â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
       â”‚              â”‚              â”‚              â”‚
       â”‚â—„â”€â”€ COMMIT â”€â”€â”€â”‚              â”‚              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ COMMIT â”€â”€â”€â”€â”‚              â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€ COMMIT â”€â”€â”€â”€â”‚
       â”‚              â”‚              â”‚              â”‚
       â”‚â”€â”€ COMMIT â”€â”€â”€â–ºâ”‚â”€â”€ COMMIT â”€â”€â”€â–ºâ”‚â”€â”€ COMMIT â”€â”€â”€â–ºâ”‚
       â”‚              â”‚              â”‚              â”‚
       â”‚      ê° ë…¸ë“œ: CommitCount >= 2f+1 (3ê°œ) í™•ì¸           â”‚
       â”‚              â”‚              â”‚              â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
       â”‚          EXECUTE ë‹¨ê³„                      â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
       â”‚              â”‚              â”‚              â”‚
       â”‚  FinalizeBlock (ABCI)                      â”‚
       â”‚  Commit (ABCI)                             â”‚
       â”‚              â”‚              â”‚              â”‚
       â”‚  FinalizeBlockâ”‚ FinalizeBlockâ”‚FinalizeBlockâ”‚
       â”‚  Commit      â”‚  Commit      â”‚  Commit      â”‚
       â”‚              â”‚              â”‚              â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
       â”‚         ë¸”ë¡ ì»¤ë°‹ ì™„ë£Œ                      â”‚
   â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•
```

### ğŸ“ ê´€ë ¨ ì½”ë“œ

```
consensus/pbft/engine_v2.go:231-296    - proposeBlock() (PRE-PREPARE)
consensus/pbft/engine_v2.go:299-367    - handlePrePrepare() (ProcessProposal)
consensus/pbft/engine_v2.go:370-406    - handlePrepare() (PREPARE ì²˜ë¦¬)
consensus/pbft/engine_v2.go:409-439    - handleCommit() (COMMIT ì²˜ë¦¬)
consensus/pbft/engine_v2.go:442-514    - executeBlock() (FinalizeBlock+Commit)
```

---

## 5. ABCI 2.0 í†µí•© íë¦„

### 5.1 ABCI ë©”ì„œë“œ ë§¤í•‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ABCI 2.0 ë©”ì„œë“œ ë§¤í•‘                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  PBFT ë‹¨ê³„                    ABCI 2.0 ë©”ì„œë“œ               ì„¤ëª…                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
â”‚                                                                                      â”‚
â”‚  íŠ¸ëœì­ì…˜ ìˆ˜ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º CheckTx                      ë©¤í’€ ì§„ì… ì „ ê²€ì¦        â”‚
â”‚                                                                                      â”‚
â”‚  PRE-PREPARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PrepareProposal              ë¸”ë¡ ì œì•ˆ ì¤€ë¹„           â”‚
â”‚  (ë¦¬ë”ê°€ ë¸”ë¡ ìƒì„±)            - íŠ¸ëœì­ì…˜ ì •ë ¬/í•„í„°ë§        (ì•±ì´ tx ì„ íƒ)          â”‚
â”‚                                - MaxTxBytes ì œí•œ                                     â”‚
â”‚                                                                                      â”‚
â”‚  PRE-PREPARE ìˆ˜ì‹  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ProcessProposal              ë¸”ë¡ ì œì•ˆ ê²€ì¦           â”‚
â”‚  (ë‹¤ë¥¸ ë…¸ë“œë“¤)                 - ACCEPT / REJECT ë°˜í™˜       (ì•±ì´ ë¸”ë¡ ê²€ì¦)         â”‚
â”‚                                                                                      â”‚
â”‚  COMMIT ì™„ë£Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º FinalizeBlock                ë¸”ë¡ ì‹¤í–‰                â”‚
â”‚  (ë¸”ë¡ í™•ì •)                   - BeginBlock                  (ìƒíƒœ ë³€ê²½)             â”‚
â”‚                                - DeliverTx (ëª¨ë“  tx)                                 â”‚
â”‚                                - EndBlock                                            â”‚
â”‚                                                                                      â”‚
â”‚  ë¸”ë¡ ì‹¤í–‰ í›„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Commit                       ìƒíƒœ ì»¤ë°‹                â”‚
â”‚                                - AppHash ë°˜í™˜                (ì˜êµ¬ ì €ì¥)             â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ABCI Adapter ìƒì„¸ íë¦„

```
     Engine V2                ABCI Adapter              Cosmos SDK App
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚                          â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚            InitChain (ì²´ì¸ ì´ˆê¸°í™”)                 â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚                        â”‚                          â”‚
          â”‚  InitChain(chainID,    â”‚                          â”‚
          â”‚    validators)         â”‚                          â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
          â”‚                        â”‚  RequestInitChain        â”‚
          â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
          â”‚                        â”‚  ResponseInitChain       â”‚
          â”‚                        â”‚  (appHash, validators)   â”‚
          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
          â”‚                        â”‚                          â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚           PrepareProposal (ë¸”ë¡ ì œì•ˆ)              â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚                        â”‚                          â”‚
          â”‚  PrepareProposal(      â”‚                          â”‚
          â”‚    height, proposer,   â”‚                          â”‚
          â”‚    txs)                â”‚                          â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
          â”‚                        â”‚  RequestPrepareProposal  â”‚
          â”‚                        â”‚  - Txs [][]byte          â”‚
          â”‚                        â”‚  - MaxTxBytes            â”‚
          â”‚                        â”‚  - Height                â”‚
          â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚      ì•±ì´ tx ì„ íƒ/ì •ë ¬   â”‚
          â”‚                        â”‚      - ìœ íš¨í•œ txë§Œ í¬í•¨  â”‚
          â”‚                        â”‚      - ìš°ì„ ìˆœìœ„ ì •ë ¬     â”‚
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
          â”‚                        â”‚  ResponsePrepareProposal â”‚
          â”‚                        â”‚  - Txs [][]byte (ì •ë ¬ë¨) â”‚
          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
          â”‚  preparedTxs           â”‚                          â”‚
          â”‚                        â”‚                          â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚           ProcessProposal (ë¸”ë¡ ê²€ì¦)              â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚                        â”‚                          â”‚
          â”‚  ProcessProposal(      â”‚                          â”‚
          â”‚    height, proposer,   â”‚                          â”‚
          â”‚    txs, hash)          â”‚                          â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
          â”‚                        â”‚  RequestProcessProposal  â”‚
          â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚      ì•±ì´ ë¸”ë¡ ê²€ì¦      â”‚
          â”‚                        â”‚      - ëª¨ë“  tx ìœ íš¨ì„±    â”‚
          â”‚                        â”‚      - ìƒíƒœ ì¼ê´€ì„±       â”‚
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
          â”‚                        â”‚  ResponseProcessProposal â”‚
          â”‚                        â”‚  - Status: ACCEPT/REJECT â”‚
          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
          â”‚  accepted (bool)       â”‚                          â”‚
          â”‚                        â”‚                          â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚            FinalizeBlock (ë¸”ë¡ ì‹¤í–‰)               â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚                        â”‚                          â”‚
          â”‚  FinalizeBlock(block)  â”‚                          â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
          â”‚                        â”‚  RequestFinalizeBlock    â”‚
          â”‚                        â”‚  - Txs                   â”‚
          â”‚                        â”‚  - Hash                  â”‚
          â”‚                        â”‚  - Height                â”‚
          â”‚                        â”‚  - Time                  â”‚
          â”‚                        â”‚  - ProposerAddress       â”‚
          â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚      ì•±ì´ ë¸”ë¡ ì‹¤í–‰      â”‚
          â”‚                        â”‚      - BeginBlock ë¡œì§   â”‚
          â”‚                        â”‚      - ê° tx DeliverTx   â”‚
          â”‚                        â”‚      - EndBlock ë¡œì§     â”‚
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
          â”‚                        â”‚  ResponseFinalizeBlock   â”‚
          â”‚                        â”‚  - TxResults []          â”‚
          â”‚                        â”‚  - ValidatorUpdates      â”‚
          â”‚                        â”‚  - AppHash               â”‚
          â”‚                        â”‚  - Events                â”‚
          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
          â”‚  ABCIExecutionResult   â”‚                          â”‚
          â”‚                        â”‚                          â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚               Commit (ìƒíƒœ ì»¤ë°‹)                   â”‚
     â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•
          â”‚                        â”‚                          â”‚
          â”‚  Commit()              â”‚                          â”‚
          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                          â”‚
          â”‚                        â”‚  RequestCommit           â”‚
          â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚      ìƒíƒœ ì˜êµ¬ ì €ì¥      â”‚
          â”‚                        â”‚      - ë””ìŠ¤í¬ í”ŒëŸ¬ì‹œ     â”‚
          â”‚                        â”‚                          â”‚
          â”‚                        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
          â”‚                        â”‚  ResponseCommit          â”‚
          â”‚                        â”‚  - RetainHeight          â”‚
          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
          â”‚  appHash, retainHeight â”‚                          â”‚
          â”‚                        â”‚                          â”‚
```

### ğŸ“ ê´€ë ¨ ì½”ë“œ

```
consensus/pbft/abci_adapter.go:53-88     - InitChain()
consensus/pbft/abci_adapter.go:90-107    - PrepareProposal()
consensus/pbft/abci_adapter.go:109-126   - ProcessProposal()
consensus/pbft/abci_adapter.go:128-161   - FinalizeBlock()
consensus/pbft/abci_adapter.go:163-175   - Commit()
abci/client.go:75-174                    - ABCI gRPC Client êµ¬í˜„
abci/types.go:47-96                      - Request/Response ë³€í™˜ í•¨ìˆ˜
```

---

## 6. ì½”ë“œ ìœ„ì¹˜ ê°€ì´ë“œ

### 6.1 ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
pbft-cosmos/
â”‚
â”œâ”€â”€ mempool/                          # ë©¤í’€ íŒ¨í‚¤ì§€
â”‚   â”œâ”€â”€ mempool.go                    # ë©”ì¸ ë©¤í’€ êµ¬í˜„
â”‚   â”‚   â”œâ”€â”€ Mempool struct            # ë©¤í’€ êµ¬ì¡°ì²´ (line 70-105)
â”‚   â”‚   â”œâ”€â”€ AddTx()                   # íŠ¸ëœì­ì…˜ ì¶”ê°€ (line 188-254)
â”‚   â”‚   â”œâ”€â”€ ReapMaxTxs()              # ë¸”ë¡ìš© tx ì¡°íšŒ (line 324-348)
â”‚   â”‚   â”œâ”€â”€ Update()                  # ë¸”ë¡ ì»¤ë°‹ í›„ ì—…ë°ì´íŠ¸ (line 392-414)
â”‚   â”‚   â””â”€â”€ expireLoop()              # ë§Œë£Œ tx ì •ë¦¬ (line 485-498)
â”‚   â”‚
â”‚   â”œâ”€â”€ reactor.go                    # ë„¤íŠ¸ì›Œí¬ ë¦¬ì•¡í„°
â”‚   â”‚   â”œâ”€â”€ Reactor struct            # ë¦¬ì•¡í„° êµ¬ì¡°ì²´ (line 75-95)
â”‚   â”‚   â”œâ”€â”€ SubmitTx()                # íŠ¸ëœì­ì…˜ ì œì¶œ (line 118-135)
â”‚   â”‚   â”œâ”€â”€ ReceiveTx()               # í”¼ì–´ì—ì„œ tx ìˆ˜ì‹  (line 160-175)
â”‚   â”‚   â””â”€â”€ broadcastLoop()           # ë¸Œë¡œë“œìºìŠ¤íŠ¸ ë£¨í”„ (line 178-210)
â”‚   â”‚
â”‚   â””â”€â”€ tx.go                         # íŠ¸ëœì­ì…˜ íƒ€ì…
â”‚       â””â”€â”€ Tx struct                 # íŠ¸ëœì­ì…˜ êµ¬ì¡°ì²´ (line 12-30)
â”‚
â”œâ”€â”€ consensus/pbft/                   # PBFT í•©ì˜ ì—”ì§„
â”‚   â”œâ”€â”€ engine_v2.go                  # ABCI 2.0 í˜¸í™˜ ì—”ì§„
â”‚   â”‚   â”œâ”€â”€ EngineV2 struct           # ì—”ì§„ êµ¬ì¡°ì²´ (line 19-55)
â”‚   â”‚   â”œâ”€â”€ run()                     # ë©”ì¸ ë£¨í”„ (line 162-175)
â”‚   â”‚   â”œâ”€â”€ proposeBlock()            # ë¸”ë¡ ì œì•ˆ (line 231-296)
â”‚   â”‚   â”œâ”€â”€ handlePrePrepare()        # PrePrepare ì²˜ë¦¬ (line 299-367)
â”‚   â”‚   â”œâ”€â”€ handlePrepare()           # Prepare ì²˜ë¦¬ (line 370-406)
â”‚   â”‚   â”œâ”€â”€ handleCommit()            # Commit ì²˜ë¦¬ (line 409-439)
â”‚   â”‚   â””â”€â”€ executeBlock()            # ë¸”ë¡ ì‹¤í–‰ (line 442-514)
â”‚   â”‚
â”‚   â”œâ”€â”€ abci_adapter.go               # ABCI ì–´ëŒ‘í„°
â”‚   â”‚   â”œâ”€â”€ ABCIAdapter struct        # ì–´ëŒ‘í„° êµ¬ì¡°ì²´ (line 18-29)
â”‚   â”‚   â”œâ”€â”€ PrepareProposal()         # ë¸”ë¡ ì œì•ˆ ì¤€ë¹„ (line 90-107)
â”‚   â”‚   â”œâ”€â”€ ProcessProposal()         # ë¸”ë¡ ì œì•ˆ ê²€ì¦ (line 109-126)
â”‚   â”‚   â”œâ”€â”€ FinalizeBlock()           # ë¸”ë¡ ì‹¤í–‰ (line 128-161)
â”‚   â”‚   â””â”€â”€ Commit()                  # ìƒíƒœ ì»¤ë°‹ (line 163-175)
â”‚   â”‚
â”‚   â”œâ”€â”€ engine.go                     # ê¸°ì¡´ PBFT ì—”ì§„
â”‚   â”œâ”€â”€ messages.go                   # ë©”ì‹œì§€ íƒ€ì… ì •ì˜
â”‚   â”œâ”€â”€ state.go                      # ìƒíƒœ ê´€ë¦¬
â”‚   â””â”€â”€ view_change.go                # ë·° ì²´ì¸ì§€ í”„ë¡œí† ì½œ
â”‚
â”œâ”€â”€ abci/                             # ABCI í´ë¼ì´ì–¸íŠ¸
â”‚   â”œâ”€â”€ client.go                     # gRPC í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚   â”œâ”€â”€ Client struct             # í´ë¼ì´ì–¸íŠ¸ êµ¬ì¡°ì²´ (line 16-28)
â”‚   â”‚   â”œâ”€â”€ InitChain()               # ì²´ì¸ ì´ˆê¸°í™” (line 80-92)
â”‚   â”‚   â”œâ”€â”€ CheckTx()                 # íŠ¸ëœì­ì…˜ ê²€ì¦ (line 94-100)
â”‚   â”‚   â”œâ”€â”€ PrepareProposal()         # ë¸”ë¡ ì œì•ˆ ì¤€ë¹„ (line 110-114)
â”‚   â”‚   â”œâ”€â”€ ProcessProposal()         # ë¸”ë¡ ì œì•ˆ ê²€ì¦ (line 116-120)
â”‚   â”‚   â”œâ”€â”€ FinalizeBlock()           # ë¸”ë¡ ì‹¤í–‰ (line 122-125)
â”‚   â”‚   â””â”€â”€ Commit()                  # ìƒíƒœ ì»¤ë°‹ (line 127-139)
â”‚   â”‚
â”‚   â””â”€â”€ types.go                      # ABCI íƒ€ì… ë³€í™˜
â”‚       â”œâ”€â”€ NewPrepareProposalRequest()   (line 47-64)
â”‚       â”œâ”€â”€ NewProcessProposalRequest()   (line 66-83)
â”‚       â”œâ”€â”€ NewFinalizeBlockRequest()     (line 85-96)
â”‚       â””â”€â”€ FinalizeBlockResponseToResult() (line 98-120)
â”‚
â”œâ”€â”€ transport/                        # ë„¤íŠ¸ì›Œí¬ ë ˆì´ì–´
â”‚   â””â”€â”€ grpc.go                       # gRPC ì „ì†¡
â”‚       â”œâ”€â”€ GRPCTransport struct      # ì „ì†¡ êµ¬ì¡°ì²´ (line 30-50)
â”‚       â”œâ”€â”€ Broadcast()               # ë¸Œë¡œë“œìºìŠ¤íŠ¸ (line 147-178)
â”‚       â”œâ”€â”€ Send()                    # íŠ¹ì • ë…¸ë“œ ì „ì†¡ (line 181-200)
â”‚       â””â”€â”€ BroadcastMessage()        # gRPC í•¸ë“¤ëŸ¬ (line 230-238)
â”‚
â”œâ”€â”€ node/                             # ë…¸ë“œ ì‹¤í–‰
â”‚   â”œâ”€â”€ node.go                       # ë…¸ë“œ êµ¬ì¡°ì²´
â”‚   â””â”€â”€ config.go                     # ì„¤ì •
â”‚
â””â”€â”€ cmd/pbftd/                        # ì‹¤í–‰ íŒŒì¼
    â””â”€â”€ main.go                       # ë©”ì¸ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
```

### 6.2 í•µì‹¬ íë¦„ë³„ ì½”ë“œ ìœ„ì¹˜

| íë¦„ | ì‹œì‘ì  | ì£¼ìš” í•¨ìˆ˜/ë©”ì„œë“œ |
|------|--------|-----------------|
| **íŠ¸ëœì­ì…˜ ì œì¶œ** | `mempool/reactor.go:118` | `SubmitTx()` â†’ `AddTxWithMeta()` |
| **ë©¤í’€ ì €ì¥** | `mempool/mempool.go:188` | `AddTx()` â†’ `addTxLocked()` |
| **ë¸”ë¡ ì œì•ˆ** | `consensus/pbft/engine_v2.go:231` | `proposeBlock()` â†’ `PrepareProposal()` |
| **ë¸”ë¡ ê²€ì¦** | `consensus/pbft/engine_v2.go:299` | `handlePrePrepare()` â†’ `ProcessProposal()` |
| **Prepare ì²˜ë¦¬** | `consensus/pbft/engine_v2.go:370` | `handlePrepare()` â†’ `IsPrepared()` |
| **Commit ì²˜ë¦¬** | `consensus/pbft/engine_v2.go:409` | `handleCommit()` â†’ `IsCommitted()` |
| **ë¸”ë¡ ì‹¤í–‰** | `consensus/pbft/engine_v2.go:442` | `executeBlock()` â†’ `FinalizeBlock()` â†’ `Commit()` |
| **ë©¤í’€ ì—…ë°ì´íŠ¸** | `mempool/mempool.go:392` | `Update()` â†’ `removeTxLocked()` |

---

## ë¶€ë¡: ìƒíƒœ ì „ì´ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              State Phase Transitions                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   Idle    â”‚  â—„â”€â”€ ì´ˆê¸° ìƒíƒœ
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ PrePrepare ìˆ˜ì‹  + ProcessProposal ACCEPT
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚PrePreparedâ”‚  â—„â”€â”€ PrePrepare ì €ì¥ë¨
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Prepare ë©”ì‹œì§€ 2f+1ê°œ ìˆ˜ì‹ 
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Prepared  â”‚  â—„â”€â”€ Prepare ì¿¼ëŸ¼ ë‹¬ì„±
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ Commit ë©”ì‹œì§€ 2f+1ê°œ ìˆ˜ì‹ 
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Committed â”‚  â—„â”€â”€ Commit ì¿¼ëŸ¼ ë‹¬ì„±
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ FinalizeBlock + Commit í˜¸ì¶œ
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Executed  â”‚  â—„â”€â”€ ë¸”ë¡ ì‹¤í–‰ ì™„ë£Œ
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ì½”ë“œ ìœ„ì¹˜: consensus/pbft/state.go
- StatePhase enum (line 15-22)
- TransitionToPrePrepared() (line 78)
- TransitionToPrepared() (line 85)
- TransitionToCommitted() (line 92)
- MarkExecuted() (line 99)
```

---

## ìš”ì•½

1. **íŠ¸ëœì­ì…˜ ì œì¶œ**: Client â†’ Reactor â†’ Mempool (CheckTx) â†’ ì €ì¥
2. **ë¸”ë¡ ì œì•ˆ**: Primaryê°€ Mempoolì—ì„œ tx ì¡°íšŒ â†’ PrepareProposal â†’ PrePrepare ë¸Œë¡œë“œìºìŠ¤íŠ¸
3. **ë¸”ë¡ ê²€ì¦**: Replicaë“¤ì´ ProcessProposal í˜¸ì¶œ â†’ ACCEPTì‹œ Prepare ì „ì†¡
4. **í•©ì˜ ì™„ë£Œ**: 2f+1 Prepare â†’ 2f+1 Commit â†’ FinalizeBlock â†’ Commit
5. **ë©¤í’€ ì •ë¦¬**: ì»¤ë°‹ëœ tx ì œê±°, ë‚¨ì€ tx Recheck
