# PBFT-Cosmos ì½”ë“œ ìŠ¤í„°ë”” ê°€ì´ë“œ

> ì´ ë¬¸ì„œëŠ” ì½”ë“œë¥¼ í•œ ì¤„ì”© ë”°ë¼ê°€ë©´ì„œ PBFT í•©ì˜ ì•Œê³ ë¦¬ì¦˜ê³¼ Cosmos SDK í†µí•©ì„ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

## ëª©ì°¨
1. [ì‹œì‘í•˜ê¸° ì „ì—](#1-ì‹œì‘í•˜ê¸°-ì „ì—)
2. [STEP 1: íŠ¸ëœì­ì…˜ì´ ë“¤ì–´ì˜¤ë©´?](#step-1-íŠ¸ëœì­ì…˜ì´-ë“¤ì–´ì˜¤ë©´)
3. [STEP 2: ë©¤í’€ì—ì„œ ì–´ë–»ê²Œ ê´€ë¦¬ë˜ë‚˜?](#step-2-ë©¤í’€ì—ì„œ-ì–´ë–»ê²Œ-ê´€ë¦¬ë˜ë‚˜)
4. [STEP 3: ë¦¬ë”ê°€ ë¸”ë¡ì„ ì œì•ˆí•˜ëŠ” ê³¼ì •](#step-3-ë¦¬ë”ê°€-ë¸”ë¡ì„-ì œì•ˆí•˜ëŠ”-ê³¼ì •)
5. [STEP 4: ë‹¤ë¥¸ ë…¸ë“œë“¤ì´ ë¸”ë¡ì„ ê²€ì¦í•˜ëŠ” ê³¼ì •](#step-4-ë‹¤ë¥¸-ë…¸ë“œë“¤ì´-ë¸”ë¡ì„-ê²€ì¦í•˜ëŠ”-ê³¼ì •)
6. [STEP 5: PREPARE ë‹¨ê³„](#step-5-prepare-ë‹¨ê³„)
7. [STEP 6: COMMIT ë‹¨ê³„](#step-6-commit-ë‹¨ê³„)
8. [STEP 7: ë¸”ë¡ ì‹¤í–‰](#step-7-ë¸”ë¡-ì‹¤í–‰)
9. [STEP 8: View Change (ë¦¬ë” êµì²´)](#step-8-view-change-ë¦¬ë”-êµì²´)
10. [í•µì‹¬ ìë£Œêµ¬ì¡° í•´ì„¤](#í•µì‹¬-ìë£Œêµ¬ì¡°-í•´ì„¤)

---

## 1. ì‹œì‘í•˜ê¸° ì „ì—

### 1.1 PBFTë€?

```
PBFT (Practical Byzantine Fault Tolerance)
= ë¹„ì”í‹´ ì¥ì• ë¥¼ ê²¬ë”œ ìˆ˜ ìˆëŠ” ì‹¤ìš©ì ì¸ í•©ì˜ ì•Œê³ ë¦¬ì¦˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚   4ê°œ ë…¸ë“œ ì¤‘ 1ê°œê°€ ì•…ì˜ì ì´ê±°ë‚˜ ê³ ì¥ë‚˜ë„ ì‹œìŠ¤í…œì´ ë™ì‘!      â”‚
â”‚                                                             â”‚
â”‚   ê³µì‹: 3f + 1 ê°œì˜ ë…¸ë“œê°€ í•„ìš” (f = í—ˆìš© ì¥ì•  ìˆ˜)           â”‚
â”‚        - f=1 ì´ë©´ 4ê°œ ë…¸ë“œ í•„ìš”                              â”‚
â”‚        - f=2 ì´ë©´ 7ê°œ ë…¸ë“œ í•„ìš”                              â”‚
â”‚                                                             â”‚
â”‚   ì¿¼ëŸ¼(Quorum) = 2f + 1 = í•©ì˜ì— í•„ìš”í•œ ìµœì†Œ ì‘ë‹µ ìˆ˜         â”‚
â”‚        - 4ë…¸ë“œë©´ 3ê°œì˜ ë™ì˜ í•„ìš”                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 í•µì‹¬ ìš©ì–´

| ìš©ì–´ | ì„¤ëª… | ì½”ë“œ ìœ„ì¹˜ |
|------|------|----------|
| **Primary (ë¦¬ë”)** | ë¸”ë¡ì„ ì œì•ˆí•˜ëŠ” ë…¸ë“œ | `engine_v2.go:isPrimary()` |
| **Replica (ë³µì œë³¸)** | Primary ì™¸ ë‚˜ë¨¸ì§€ ë…¸ë“œë“¤ | - |
| **View** | í˜„ì¬ ë¦¬ë” ë²ˆí˜¸ (ë¦¬ë” = view % ë…¸ë“œìˆ˜) | `engine_v2.go:24` |
| **Sequence Number** | ë¸”ë¡ ë†’ì´ | `engine_v2.go:25` |
| **Quorum** | í•©ì˜ì— í•„ìš”í•œ ìµœì†Œ ë…¸ë“œ ìˆ˜ (2f+1) | `types/validator.go` |

### 1.3 íŒŒì¼ êµ¬ì¡° ë¯¸ë¦¬ë³´ê¸°

```
ì½”ë“œë¥¼ ì½ëŠ” ìˆœì„œëŒ€ë¡œ íŒŒì¼ì„ ë‚˜ì—´í–ˆìŠµë‹ˆë‹¤:

1. mempool/tx.go          â† íŠ¸ëœì­ì…˜ êµ¬ì¡°ì²´
2. mempool/mempool.go     â† íŠ¸ëœì­ì…˜ í’€ ê´€ë¦¬
3. mempool/reactor.go     â† ë„¤íŠ¸ì›Œí¬ ì—°ê²°

4. consensus/pbft/messages.go   â† PBFT ë©”ì‹œì§€ íƒ€ì…ë“¤
5. consensus/pbft/state.go      â† í•©ì˜ ìƒíƒœ ê´€ë¦¬
6. consensus/pbft/engine_v2.go  â† ë©”ì¸ í•©ì˜ ë¡œì§ â­

7. consensus/pbft/abci_adapter.go  â† Cosmos SDK ì—°ê²°
8. abci/client.go                  â† ABCI gRPC í´ë¼ì´ì–¸íŠ¸
```

---

## STEP 1: íŠ¸ëœì­ì…˜ì´ ë“¤ì–´ì˜¤ë©´?

### ğŸ“ íŒŒì¼: `mempool/reactor.go`

í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¸ëœì­ì…˜ì„ ë³´ë‚´ë©´ ê°€ì¥ ë¨¼ì € Reactorê°€ ë°›ìŠµë‹ˆë‹¤.

```go
// ğŸ“ mempool/reactor.go:118-135

// SubmitTx - í´ë¼ì´ì–¸íŠ¸ê°€ íŠ¸ëœì­ì…˜ì„ ì œì¶œí•  ë•Œ í˜¸ì¶œë¨
func (r *Reactor) SubmitTx(txBytes []byte) error {
    return r.SubmitTxWithMeta(txBytes, "", 0, 0, 0)
}

// SubmitTxWithMeta - ë©”íƒ€ë°ì´í„°ì™€ í•¨ê»˜ íŠ¸ëœì­ì…˜ ì œì¶œ
func (r *Reactor) SubmitTxWithMeta(
    txBytes []byte,      // íŠ¸ëœì­ì…˜ ì›ë³¸ ë°”ì´íŠ¸
    sender string,       // ë°œì‹ ì ì£¼ì†Œ (ì˜ˆ: "cosmos1abc...")
    nonce uint64,        // ë°œì‹ ìì˜ íŠ¸ëœì­ì…˜ ìˆœì„œ ë²ˆí˜¸
    gasPrice uint64,     // ê°€ìŠ¤ ê°€ê²© (ë†’ì„ìˆ˜ë¡ ìš°ì„  ì²˜ë¦¬)
    gasLimit uint64,     // ìµœëŒ€ ê°€ìŠ¤ í•œë„
) error {

    // â‘  ë©¤í’€ì— íŠ¸ëœì­ì…˜ ì¶”ê°€
    if err := r.mempool.AddTxWithMeta(txBytes, sender, nonce, gasPrice, gasLimit); err != nil {
        return err  // ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬ ë°˜í™˜ (ì¤‘ë³µ, ìš©ëŸ‰ ì´ˆê³¼ ë“±)
    }

    // â‘¡ ë¸Œë¡œë“œìºìŠ¤íŠ¸ íì— ì¶”ê°€ (ë‹¤ë¥¸ ë…¸ë“œë“¤ì—ê²Œ ì „íŒŒí•˜ê¸° ìœ„í•´)
    if r.config.BroadcastEnabled {
        tx := NewTxWithMeta(txBytes, sender, nonce, gasPrice, gasLimit)
        select {
        case r.broadcastQueue <- tx:  // íì— ë„£ê¸° ì„±ê³µ
        default:
            // íê°€ ê°€ë“ ì°¨ë©´ ë¬´ì‹œ (ì´ë¯¸ ë©¤í’€ì—ëŠ” ì¶”ê°€ë¨)
        }
    }

    return nil
}
```

**ğŸ” í•´ì„¤:**
1. í´ë¼ì´ì–¸íŠ¸ê°€ `SubmitTx(txBytes)`ë¥¼ í˜¸ì¶œ
2. ë©¤í’€ì— ì €ì¥ ì‹œë„
3. ì„±ê³µí•˜ë©´ ë‹¤ë¥¸ ë…¸ë“œë“¤ì—ê²Œ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ íì— ì¶”ê°€
4. ë¸Œë¡œë“œìºìŠ¤íŠ¸ëŠ” ë³„ë„ ê³ ë£¨í‹´ì—ì„œ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬ë¨

---

## STEP 2: ë©¤í’€ì—ì„œ ì–´ë–»ê²Œ ê´€ë¦¬ë˜ë‚˜?

### ğŸ“ íŒŒì¼: `mempool/mempool.go`

ë©¤í’€ì€ ì•„ì§ ë¸”ë¡ì— í¬í•¨ë˜ì§€ ì•Šì€ íŠ¸ëœì­ì…˜ë“¤ì„ ë³´ê´€í•©ë‹ˆë‹¤.

### 2.1 ë©¤í’€ êµ¬ì¡°ì²´

```go
// ğŸ“ mempool/mempool.go:70-105

type Mempool struct {
    mu sync.RWMutex  // ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ ë½

    config *Config   // ì„¤ì • (ìµœëŒ€ í¬ê¸°, TTL ë“±)

    // â­ í•µì‹¬ ì €ì¥ì†Œ 1: í•´ì‹œë¡œ íŠ¸ëœì­ì…˜ ì°¾ê¸°
    txStore map[string]*Tx  // key: íŠ¸ëœì­ì…˜ í•´ì‹œ, value: íŠ¸ëœì­ì…˜

    // â­ í•µì‹¬ ì €ì¥ì†Œ 2: ë°œì‹ ìë³„ë¡œ íŠ¸ëœì­ì…˜ ë¬¶ê¸°
    senderIndex map[string][]*Tx  // key: ë°œì‹ ì ì£¼ì†Œ, value: í•´ë‹¹ ë°œì‹ ìì˜ tx ëª©ë¡

    // í˜„ì¬ ìƒíƒœ
    txCount int    // í˜„ì¬ íŠ¸ëœì­ì…˜ ìˆ˜
    txBytes int64  // í˜„ì¬ ì´ ë°”ì´íŠ¸ ìˆ˜
    height  int64  // í˜„ì¬ ë¸”ë¡ ë†’ì´

    // ë°œì‹ ìë³„ ë§ˆì§€ë§‰ nonce (ìˆœì„œ ê²€ì¦ìš©)
    senderNonce map[string]uint64

    // ìµœê·¼ ì œê±°ëœ tx ìºì‹œ (ì¤‘ë³µ ì¶”ê°€ ë°©ì§€)
    recentlyRemoved map[string]time.Time

    // CheckTx ì½œë°± (ABCI ì•±ì—ì„œ ê²€ì¦)
    checkTxCallback CheckTxCallback

    // ...
}
```

**ğŸ” ê·¸ë¦¼ìœ¼ë¡œ ì´í•´í•˜ê¸°:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MEMPOOL                              â”‚
â”‚                                                              â”‚
â”‚   txStore (í•´ì‹œ â†’ íŠ¸ëœì­ì…˜)                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  "abc123" â†’ Tx{sender:"alice", nonce:1, gas:100}    â”‚   â”‚
â”‚   â”‚  "def456" â†’ Tx{sender:"bob",   nonce:1, gas:80}     â”‚   â”‚
â”‚   â”‚  "ghi789" â†’ Tx{sender:"alice", nonce:2, gas:120}    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚   senderIndex (ë°œì‹ ì â†’ íŠ¸ëœì­ì…˜ ëª©ë¡)                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  "alice" â†’ [Tx{nonce:1}, Tx{nonce:2}]  â† nonce ìˆœì„œ â”‚   â”‚
â”‚   â”‚  "bob"   â†’ [Tx{nonce:1}]                            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 íŠ¸ëœì­ì…˜ ì¶”ê°€ ë¡œì§

```go
// ğŸ“ mempool/mempool.go:188-254

func (mp *Mempool) AddTxWithMeta(
    txBytes []byte,
    sender string,
    nonce, gasPrice, gasLimit uint64,
) error {
    mp.mu.Lock()
    defer mp.mu.Unlock()

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ 1: íŠ¸ëœì­ì…˜ í¬ê¸° ì²´í¬
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if len(txBytes) > mp.config.MaxTxBytes {
        return fmt.Errorf("tx too large: %d > %d", len(txBytes), mp.config.MaxTxBytes)
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // íŠ¸ëœì­ì…˜ ê°ì²´ ìƒì„± (í•´ì‹œ ê³„ì‚° í¬í•¨)
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    tx := NewTxWithMeta(txBytes, sender, nonce, gasPrice, gasLimit)
    tx.Height = mp.height

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ 2: ì¤‘ë³µ ì²´í¬ - ì´ë¯¸ ìˆëŠ” íŠ¸ëœì­ì…˜ì¸ê°€?
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if _, exists := mp.txStore[tx.ID]; exists {
        return ErrTxAlreadyExists  // "ì´ë¯¸ ë©¤í’€ì— ìˆìŒ"
    }

    // ìµœê·¼ì— ì œê±°ëœ txì¸ì§€ë„ ì²´í¬ (ì¬ì¶”ê°€ ë°©ì§€)
    if _, removed := mp.recentlyRemoved[tx.ID]; removed {
        return ErrTxAlreadyExists
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ 3: ê°€ìŠ¤ ê°€ê²© ì²´í¬
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if gasPrice < mp.config.MinGasPrice {
        return fmt.Errorf("gas price too low: %d < %d", gasPrice, mp.config.MinGasPrice)
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ 4: Nonce ì²´í¬ (senderê°€ ìˆëŠ” ê²½ìš°)
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if sender != "" {
        if err := mp.checkNonce(sender, nonce); err != nil {
            return err
        }
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ 5: ABCI ì•±ì—ì„œ ê²€ì¦ (CheckTx)
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if mp.checkTxCallback != nil {
        if err := mp.checkTxCallback(tx); err != nil {
            return fmt.Errorf("CheckTx failed: %v", err)
        }
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ 6: ìš©ëŸ‰ ì²´í¬ - ê½‰ ì°¼ìœ¼ë©´ ë‚®ì€ ê°€ìŠ¤ tx í‡´ì¶œ
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if err := mp.ensureCapacity(tx); err != nil {
        return err
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ëª¨ë“  ê²€ì¦ í†µê³¼! ì €ì¥í•˜ê¸°
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    mp.addTxLocked(tx)

    return nil
}
```

**ğŸ” í•´ì„¤:**
íŠ¸ëœì­ì…˜ì´ ë©¤í’€ì— ë“¤ì–´ê°€ê¸° ì „ 6ë‹¨ê³„ ê²€ì¦ì„ ê±°ì¹©ë‹ˆë‹¤:
1. **í¬ê¸° ì²´í¬**: ë„ˆë¬´ í° tx ê±°ë¶€
2. **ì¤‘ë³µ ì²´í¬**: ì´ë¯¸ ìˆëŠ” tx ê±°ë¶€
3. **ê°€ìŠ¤ ê°€ê²© ì²´í¬**: ë„ˆë¬´ ë‚®ì€ ê°€ìŠ¤ ê±°ë¶€
4. **Nonce ì²´í¬**: ìˆœì„œê°€ ë§ì§€ ì•ŠëŠ” tx ê±°ë¶€
5. **ABCI CheckTx**: ì•± ë ˆë²¨ì—ì„œ ìœ íš¨ì„± ê²€ì¦
6. **ìš©ëŸ‰ ì²´í¬**: ê½‰ ì°¼ìœ¼ë©´ ë‚®ì€ ê°€ìŠ¤ tx í‡´ì¶œ

### 2.3 ë¸”ë¡ ì œì•ˆìš© íŠ¸ëœì­ì…˜ ì¡°íšŒ

```go
// ğŸ“ mempool/mempool.go:324-348

// ReapMaxTxs - ë¸”ë¡ì— ë„£ì„ íŠ¸ëœì­ì…˜ë“¤ì„ ê°€ì ¸ì˜´
// Primary(ë¦¬ë”)ê°€ ë¸”ë¡ì„ ë§Œë“¤ ë•Œ í˜¸ì¶œ
func (mp *Mempool) ReapMaxTxs(max int) []*Tx {
    mp.mu.RLock()
    defer mp.mu.RUnlock()

    // maxê°€ 0ì´ê±°ë‚˜ ë„ˆë¬´ í¬ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
    if max <= 0 || max > mp.config.MaxBatchTxs {
        max = mp.config.MaxBatchTxs  // ê¸°ë³¸: 500
    }

    if mp.txCount == 0 {
        return nil  // ë©¤í’€ì´ ë¹„ì–´ìˆìŒ
    }

    // â‘  ëª¨ë“  íŠ¸ëœì­ì…˜ì„ ìŠ¬ë¼ì´ìŠ¤ë¡œ ë³µì‚¬
    txs := make([]*Tx, 0, mp.txCount)
    for _, tx := range mp.txStore {
        txs = append(txs, tx)
    }

    // â‘¡ GasPrice ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ë†’ì€ ê°€ìŠ¤ = ë†’ì€ ìš°ì„ ìˆœìœ„)
    sort.Slice(txs, func(i, j int) bool {
        return txs[i].GasPrice > txs[j].GasPrice
    })

    // â‘¢ ìƒìœ„ maxê°œë§Œ ë°˜í™˜
    if len(txs) > max {
        txs = txs[:max]
    }

    return txs
}
```

**ğŸ” ê·¸ë¦¼ìœ¼ë¡œ ì´í•´í•˜ê¸°:**

```
ë©¤í’€ì— ìˆëŠ” íŠ¸ëœì­ì…˜ë“¤:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tx1{gas:50}  tx2{gas:120}  tx3{gas:80}  tx4{gas:200}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼ GasPrice ì •ë ¬
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tx4{gas:200} â†’ tx2{gas:120} â†’ tx3{gas:80} â†’ tx1{gas:50}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼ ìƒìœ„ Nê°œ ì„ íƒ (max=3)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tx4{gas:200}  tx2{gas:120}  tx3{gas:80}                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼ ë¸”ë¡ì— í¬í•¨!
```

---

## STEP 3: ë¦¬ë”ê°€ ë¸”ë¡ì„ ì œì•ˆí•˜ëŠ” ê³¼ì •

### ğŸ“ íŒŒì¼: `consensus/pbft/engine_v2.go`

ì´ì œ í•µì‹¬ì¸ PBFT ì—”ì§„ì„ ë´…ë‹ˆë‹¤. ë¦¬ë”(Primary)ê°€ ë¸”ë¡ì„ ì œì•ˆí•©ë‹ˆë‹¤.

### 3.1 ë©”ì¸ ë£¨í”„

```go
// ğŸ“ consensus/pbft/engine_v2.go:162-175

// run - ì—”ì§„ì˜ ë©”ì¸ ë£¨í”„ (ê³ ë£¨í‹´ìœ¼ë¡œ ì‹¤í–‰ë¨)
func (e *EngineV2) run() {
    for {
        select {
        case <-e.ctx.Done():
            // ì¢…ë£Œ ì‹ í˜¸ë¥¼ ë°›ìœ¼ë©´ ë£¨í”„ íƒˆì¶œ
            return

        case msg := <-e.msgChan:
            // ë‹¤ë¥¸ ë…¸ë“œì—ì„œ ë©”ì‹œì§€ê°€ ì˜´ (PrePrepare, Prepare, Commit ë“±)
            e.handleMessage(msg)

        case req := <-e.requestChan:
            // í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ì´ ì˜´ (íŠ¸ëœì­ì…˜)
            if e.isPrimary() {
                // ë‚´ê°€ ë¦¬ë”ë©´ ë¸”ë¡ ì œì•ˆ!
                e.proposeBlock(req)
            }
            // ë¦¬ë”ê°€ ì•„ë‹ˆë©´? ë¬´ì‹œ (ë¦¬ë”í•œí…Œ ë³´ë‚´ì•¼ í•¨)
        }
    }
}
```

**ğŸ” í•´ì„¤:**
ì—”ì§„ì€ ë¬´í•œ ë£¨í”„ë¥¼ ëŒë©´ì„œ ë‘ ê°€ì§€ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤:
1. **msgChan**: ë‹¤ë¥¸ ë…¸ë“œì—ì„œ ì˜¤ëŠ” í•©ì˜ ë©”ì‹œì§€
2. **requestChan**: í´ë¼ì´ì–¸íŠ¸ì˜ íŠ¸ëœì­ì…˜ ìš”ì²­

### 3.2 ë¦¬ë”ì¸ì§€ í™•ì¸í•˜ëŠ” ë°©ë²•

```go
// ğŸ“ consensus/pbft/engine_v2.go:212-219

// isPrimary - í˜„ì¬ ë…¸ë“œê°€ ë¦¬ë”ì¸ì§€ í™•ì¸
func (e *EngineV2) isPrimary() bool {
    e.mu.RLock()
    defer e.mu.RUnlock()

    // ë¦¬ë” = view ë²ˆí˜¸ë¥¼ ë…¸ë“œ ìˆ˜ë¡œ ë‚˜ëˆˆ ë‚˜ë¨¸ì§€
    primaryIdx := int(e.view) % len(e.validatorSet.Validators)

    // ë‚´ IDì™€ ë¦¬ë” IDê°€ ê°™ìœ¼ë©´ ë‚´ê°€ ë¦¬ë”!
    return e.validatorSet.Validators[primaryIdx].ID == e.config.NodeID
}
```

**ğŸ” ì˜ˆì‹œ:**
```
4ê°œ ë…¸ë“œ: [node0, node1, node2, node3]

view=0: ë¦¬ë” = 0 % 4 = node0
view=1: ë¦¬ë” = 1 % 4 = node1
view=2: ë¦¬ë” = 2 % 4 = node2
view=3: ë¦¬ë” = 3 % 4 = node3
view=4: ë¦¬ë” = 4 % 4 = node0 (ë‹¤ì‹œ ì²˜ìŒë¶€í„°)
```

### 3.3 ë¸”ë¡ ì œì•ˆ (PRE-PREPARE)

```go
// ğŸ“ consensus/pbft/engine_v2.go:231-296

// proposeBlock - ë¦¬ë”ê°€ ë¸”ë¡ì„ ì œì•ˆ (PRE-PREPARE ë‹¨ê³„)
func (e *EngineV2) proposeBlock(req *RequestMsg) {

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘  ì‹œí€€ìŠ¤ ë²ˆí˜¸ ì¦ê°€ (= ë¸”ë¡ ë†’ì´)
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    e.mu.Lock()
    e.sequenceNum++
    seqNum := e.sequenceNum  // ì˜ˆ: 1, 2, 3, ...
    view := e.view           // í˜„ì¬ ë·° ë²ˆí˜¸
    e.mu.Unlock()

    // ìœˆë„ìš° ë²”ìœ„ ì²´í¬ (ë„ˆë¬´ ì•ì„œê°€ë©´ ì•ˆ ë¨)
    if !e.stateLog.IsInWindow(seqNum) {
        e.logger.Printf("Sequence %d out of window", seqNum)
        return
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘¡ íŠ¸ëœì­ì…˜ ìˆ˜ì§‘
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    var txs [][]byte
    if req != nil {
        txs = append(txs, req.Operation)
    }
    // ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ ë©¤í’€ì—ì„œ ë” ê°€ì ¸ì˜´:
    // txs = append(txs, mempool.ReapMaxTxs(500)...)

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘¢ ABCI PrepareProposal í˜¸ì¶œ
    //    â†’ Cosmos SDK ì•±ì—ê²Œ "ì´ íŠ¸ëœì­ì…˜ë“¤ë¡œ ë¸”ë¡ ë§Œë“¤ì–´ë„ ë¼?"
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ctx, cancel := context.WithTimeout(e.ctx, 5*time.Second)
    defer cancel()

    proposer := []byte(e.config.NodeID)
    preparedTxs, err := e.abciAdapter.PrepareProposal(ctx, int64(seqNum), proposer, txs)
    //                  â†‘
    //  ì•±ì´ íŠ¸ëœì­ì…˜ì„ ì •ë ¬/í•„í„°ë§í•´ì„œ ëŒë ¤ì¤Œ
    //  (ë¬´íš¨í•œ tx ì œê±°, ìš°ì„ ìˆœìœ„ ì •ë ¬ ë“±)

    if err != nil {
        e.logger.Printf("PrepareProposal failed: %v", err)
        return
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘£ ë¸”ë¡ ìƒì„±
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    var prevHash []byte
    if len(e.committedBlocks) > 0 {
        prevHash = e.committedBlocks[len(e.committedBlocks)-1].Hash
    }

    // íŠ¸ëœì­ì…˜ ë°”ì´íŠ¸ë¥¼ Transaction êµ¬ì¡°ì²´ë¡œ ë³€í™˜
    transactions := make([]types.Transaction, len(preparedTxs))
    for i, txBytes := range preparedTxs {
        transactions[i] = types.Transaction{
            ID:        fmt.Sprintf("tx-%d-%d", seqNum, i),
            Data:      txBytes,
            Timestamp: time.Now(),
        }
    }

    // ë¸”ë¡ ìƒì„±! (í•´ì‹œë„ ìë™ ê³„ì‚°ë¨)
    block := types.NewBlock(seqNum, prevHash, e.config.NodeID, view, transactions)

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘¤ PRE-PREPARE ë©”ì‹œì§€ ìƒì„±
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    prePrepareMsg := NewPrePrepareMsg(view, seqNum, block, e.config.NodeID)

    // ìƒíƒœ ì €ì¥ì†Œì— ì €ì¥
    state := e.stateLog.GetState(view, seqNum)
    state.SetPrePrepare(prePrepareMsg, block)

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘¥ ë¸Œë¡œë“œìºìŠ¤íŠ¸! (ëª¨ë“  ë…¸ë“œì—ê²Œ ì „ì†¡)
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    payload, _ := json.Marshal(prePrepareMsg)
    msg := NewMessage(PrePrepare, view, seqNum, block.Hash, e.config.NodeID)
    msg.Payload = payload

    e.broadcast(msg)  // ëª¨ë“  ë…¸ë“œì—ê²Œ ì „ì†¡!

    e.logger.Printf("Primary broadcast PRE-PREPARE for seq %d", seqNum)
}
```

**ğŸ” íë¦„ ì •ë¦¬:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    proposeBlock() íë¦„                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â‘  sequenceNum++ (ë¸”ë¡ ë†’ì´ ì¦ê°€)                            â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¡ íŠ¸ëœì­ì…˜ ìˆ˜ì§‘ (ë©¤í’€ì—ì„œ)                                  â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¢ PrepareProposal í˜¸ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Cosmos SDK ì•±            â”‚
â”‚           â”‚                              â”‚                   â”‚
â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€ ì •ë ¬ëœ tx ë°˜í™˜ â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘£ Block ìƒì„± (prevHash, txs, ...)                          â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¤ PrePrepareMsg ìƒì„±                                       â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¥ broadcast() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [Node1, Node2, Node3]     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## STEP 4: ë‹¤ë¥¸ ë…¸ë“œë“¤ì´ ë¸”ë¡ì„ ê²€ì¦í•˜ëŠ” ê³¼ì •

### ğŸ“ íŒŒì¼: `consensus/pbft/engine_v2.go`

ë¦¬ë”ê°€ ë³´ë‚¸ PRE-PREPAREë¥¼ ë°›ì€ ë‹¤ë¥¸ ë…¸ë“œë“¤ì´ ê²€ì¦í•©ë‹ˆë‹¤.

```go
// ğŸ“ consensus/pbft/engine_v2.go:299-367

// handlePrePrepare - PRE-PREPARE ë©”ì‹œì§€ ì²˜ë¦¬
func (e *EngineV2) handlePrePrepare(msg *Message) {

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ 1: ì§„ì§œ ë¦¬ë”ê°€ ë³´ë‚¸ ê±´ê°€?
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if msg.NodeID != e.getPrimaryID() {
        e.logger.Printf("PRE-PREPARE from non-primary %s (expected %s)",
            msg.NodeID, e.getPrimaryID())
        return  // ë¬´ì‹œ!
    }

    e.mu.RLock()
    currentView := e.view
    e.mu.RUnlock()

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ 2: ê°™ì€ ë·°ì¸ê°€?
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if msg.View != currentView {
        return  // ë‹¤ë¥¸ ë·°ì˜ ë©”ì‹œì§€ëŠ” ë¬´ì‹œ
    }

    // ìœˆë„ìš° ë²”ìœ„ ì²´í¬
    if !e.stateLog.IsInWindow(msg.SequenceNum) {
        return
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ë©”ì‹œì§€ ë””ì½”ë”©
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    var prePrepareMsg PrePrepareMsg
    if err := json.Unmarshal(msg.Payload, &prePrepareMsg); err != nil {
        e.logger.Printf("Failed to decode PRE-PREPARE: %v", err)
        return
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ 3: ABCI ProcessProposal - ì•±ì—ì„œ ë¸”ë¡ ê²€ì¦
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ctx, cancel := context.WithTimeout(e.ctx, 5*time.Second)
    defer cancel()

    // ë¸”ë¡ì˜ íŠ¸ëœì­ì…˜ë“¤ ì¶”ì¶œ
    txs := make([][]byte, len(prePrepareMsg.Block.Transactions))
    for i, tx := range prePrepareMsg.Block.Transactions {
        txs[i] = tx.Data
    }

    proposer := []byte(prePrepareMsg.PrimaryID)

    // ì•±ì—ê²Œ "ì´ ë¸”ë¡ ê´œì°®ì•„?" ë¬¼ì–´ë³´ê¸°
    accepted, err := e.abciAdapter.ProcessProposal(
        ctx,
        int64(msg.SequenceNum),
        proposer,
        txs,
        msg.Digest,  // ë¸”ë¡ í•´ì‹œ
    )

    if err != nil {
        e.logger.Printf("ProcessProposal error: %v", err)
        return
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ì•±ì´ ê±°ë¶€í•˜ë©´?
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if !accepted {
        e.logger.Printf("ProcessProposal REJECTED block at seq %d", msg.SequenceNum)
        return  // ì—¬ê¸°ì„œ ë! Prepare ì•ˆ ë³´ëƒ„
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ê²€ì¦ í†µê³¼! ìƒíƒœ ì €ì¥
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    state := e.stateLog.GetState(msg.View, msg.SequenceNum)
    state.SetPrePrepare(&prePrepareMsg, prePrepareMsg.Block)

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // PREPARE ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸!
    // "ë‚˜ëŠ” ì´ ë¸”ë¡ì— ë™ì˜í•´!"
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    prepareMsg := NewPrepareMsg(msg.View, msg.SequenceNum, msg.Digest, e.config.NodeID)
    payload, _ := json.Marshal(prepareMsg)
    prepareNetMsg := NewMessage(Prepare, msg.View, msg.SequenceNum, msg.Digest, e.config.NodeID)
    prepareNetMsg.Payload = payload

    e.broadcast(prepareNetMsg)  // ëª¨ë“  ë…¸ë“œì—ê²Œ!

    e.resetViewChangeTimer()  // íƒ€ì´ë¨¸ ë¦¬ì…‹ (ë¦¬ë”ê°€ ì‚´ì•„ìˆìŒ!)

    e.logger.Printf("Node %s sent PREPARE for seq %d (ACCEPTED)", e.config.NodeID, msg.SequenceNum)
}
```

**ğŸ” íë¦„ ì •ë¦¬:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 handlePrePrepare() íë¦„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  PRE-PREPARE ë©”ì‹œì§€ ìˆ˜ì‹                                      â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘  ë¦¬ë” í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ì•„ë‹ˆë©´ ë¬´ì‹œ                â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¡ ë·° í™•ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ë‹¤ë¥´ë©´ ë¬´ì‹œ                â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¢ ProcessProposal í˜¸ì¶œ â”€â”€â”€â”€â”€â”€â”€â–º Cosmos SDK ì•±              â”‚
â”‚           â”‚                              â”‚                   â”‚
â”‚           â”‚                     ë¸”ë¡ ê²€ì¦ (tx ìœ íš¨ì„± ë“±)     â”‚
â”‚           â”‚                              â”‚                   â”‚
â”‚           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ACCEPT/REJECT â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                                                  â”‚
â”‚      REJECT?â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ë¬´ì‹œí•˜ê³  ë                 â”‚
â”‚           â”‚                                                  â”‚
â”‚       ACCEPT                                                 â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘£ ìƒíƒœ ì €ì¥ (PrePrepare)                                   â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¤ PREPARE ë¸Œë¡œë“œìºìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â–º [ëª¨ë“  ë…¸ë“œ]               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## STEP 5: PREPARE ë‹¨ê³„

### ğŸ“ íŒŒì¼: `consensus/pbft/engine_v2.go`

ê° ë…¸ë“œê°€ ë³´ë‚¸ PREPAREë¥¼ ìˆ˜ì§‘í•˜ê³ , 2f+1ê°œê°€ ëª¨ì´ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ.

```go
// ğŸ“ consensus/pbft/engine_v2.go:370-406

// handlePrepare - PREPARE ë©”ì‹œì§€ ì²˜ë¦¬
func (e *EngineV2) handlePrepare(msg *Message) {
    e.mu.RLock()
    currentView := e.view
    e.mu.RUnlock()

    // ê°™ì€ ë·°ì¸ì§€ í™•ì¸
    if msg.View != currentView {
        return
    }

    // ë©”ì‹œì§€ ë””ì½”ë”©
    var prepareMsg PrepareMsg
    if err := json.Unmarshal(msg.Payload, &prepareMsg); err != nil {
        e.logger.Printf("Failed to decode PREPARE: %v", err)
        return
    }

    // í•´ë‹¹ ì‹œí€€ìŠ¤ ë²ˆí˜¸ì˜ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    state := e.stateLog.GetExistingState(msg.SequenceNum)
    if state == nil {
        return  // PrePrepareë¥¼ ì•„ì§ ì•ˆ ë°›ì•˜ìŒ
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // PREPARE ë©”ì‹œì§€ ì¶”ê°€
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    state.AddPrepare(&prepareMsg)

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ì¿¼ëŸ¼ ì²´í¬: 2f+1ê°œì˜ PREPAREë¥¼ ë°›ì•˜ë‚˜?
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    quorum := e.validatorSet.QuorumSize()  // 4ë…¸ë“œë©´ 3

    // ì¡°ê±´: Prepare ì¿¼ëŸ¼ ë‹¬ì„± + ì•„ì§ PrePrepared ìƒíƒœ
    if state.IsPrepared(quorum) && state.GetPhase() == PrePrepared {

        // ìƒíƒœ ì „ì´: PrePrepared â†’ Prepared
        state.TransitionToPrepared()

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // COMMIT ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸!
        // "2f+1 ë…¸ë“œê°€ ë™ì˜í–ˆìœ¼ë‹ˆ ë‚˜ë„ ì»¤ë°‹í•  ì¤€ë¹„ ëì–´!"
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        commitMsg := NewCommitMsg(msg.View, msg.SequenceNum, msg.Digest, e.config.NodeID)
        payload, _ := json.Marshal(commitMsg)
        commitNetMsg := NewMessage(Commit, msg.View, msg.SequenceNum, msg.Digest, e.config.NodeID)
        commitNetMsg.Payload = payload

        e.broadcast(commitNetMsg)

        e.logger.Printf("Node %s PREPARED and sent COMMIT (prepares: %d)",
            e.config.NodeID, state.PrepareCount())
    }
}
```

**ğŸ” ê·¸ë¦¼ìœ¼ë¡œ ì´í•´í•˜ê¸°:**

```
4ë…¸ë“œ ê¸°ì¤€ (f=1, ì¿¼ëŸ¼=3)

Node0ì—ì„œì˜ PREPARE ìˆ˜ì§‘:

          ì‹œê°„ â†’
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                      â”‚
    â”‚  Node1ì—ì„œ PREPARE ë„ì°© â”€â”€â–º PrepareCount = 1        â”‚
    â”‚                                                      â”‚
    â”‚  Node2ì—ì„œ PREPARE ë„ì°© â”€â”€â–º PrepareCount = 2        â”‚
    â”‚                                                      â”‚
    â”‚  Node3ì—ì„œ PREPARE ë„ì°© â”€â”€â–º PrepareCount = 3 â‰¥ ì¿¼ëŸ¼! â”‚
    â”‚                              â”‚                       â”‚
    â”‚                              â–¼                       â”‚
    â”‚                    ìƒíƒœ: PrePrepared â†’ Prepared      â”‚
    â”‚                              â”‚                       â”‚
    â”‚                              â–¼                       â”‚
    â”‚                    COMMIT ë¸Œë¡œë“œìºìŠ¤íŠ¸!              â”‚
    â”‚                                                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## STEP 6: COMMIT ë‹¨ê³„

### ğŸ“ íŒŒì¼: `consensus/pbft/engine_v2.go`

COMMITë„ 2f+1ê°œê°€ ëª¨ì´ë©´ ë¸”ë¡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

```go
// ğŸ“ consensus/pbft/engine_v2.go:409-439

// handleCommit - COMMIT ë©”ì‹œì§€ ì²˜ë¦¬
func (e *EngineV2) handleCommit(msg *Message) {
    e.mu.RLock()
    currentView := e.view
    e.mu.RUnlock()

    if msg.View != currentView {
        return
    }

    var commitMsg CommitMsg
    if err := json.Unmarshal(msg.Payload, &commitMsg); err != nil {
        e.logger.Printf("Failed to decode COMMIT: %v", err)
        return
    }

    state := e.stateLog.GetExistingState(msg.SequenceNum)
    if state == nil {
        return
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // COMMIT ë©”ì‹œì§€ ì¶”ê°€
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    state.AddCommit(&commitMsg)

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ì¿¼ëŸ¼ ì²´í¬: 2f+1ê°œì˜ COMMITì„ ë°›ì•˜ë‚˜?
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    quorum := e.validatorSet.QuorumSize()

    // ì¡°ê±´: Commit ì¿¼ëŸ¼ ë‹¬ì„± + ì•„ì§ Prepared ìƒíƒœ
    if state.IsCommitted(quorum) && state.GetPhase() == Prepared {

        // ìƒíƒœ ì „ì´: Prepared â†’ Committed
        state.TransitionToCommitted()

        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        // ë“œë””ì–´ ë¸”ë¡ ì‹¤í–‰!!! ğŸ‰
        // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        e.executeBlock(state)

        e.logger.Printf("Node %s COMMITTED seq %d (commits: %d)",
            e.config.NodeID, msg.SequenceNum, state.CommitCount())
    }
}
```

---

## STEP 7: ë¸”ë¡ ì‹¤í–‰

### ğŸ“ íŒŒì¼: `consensus/pbft/engine_v2.go`

í•©ì˜ê°€ ì™„ë£Œë˜ë©´ ì‹¤ì œë¡œ ë¸”ë¡ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

```go
// ğŸ“ consensus/pbft/engine_v2.go:442-514

// executeBlock - ë¸”ë¡ ì‹¤í–‰ (ABCI FinalizeBlock + Commit)
func (e *EngineV2) executeBlock(state *State) {
    // ì´ë¯¸ ì‹¤í–‰í–ˆê±°ë‚˜ ë¸”ë¡ì´ ì—†ìœ¼ë©´ ë¦¬í„´
    if state.Executed || state.Block == nil {
        return
    }

    startTime := time.Now()
    ctx, cancel := context.WithTimeout(e.ctx, 30*time.Second)
    defer cancel()

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘  ABCI FinalizeBlock í˜¸ì¶œ
    //    â†’ ì•±ì—ì„œ ë¸”ë¡ì˜ ëª¨ë“  íŠ¸ëœì­ì…˜ ì‹¤í–‰
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    result, err := e.abciAdapter.FinalizeBlock(ctx, state.Block)
    if err != nil {
        e.logger.Printf("FinalizeBlock failed: %v", err)
        return
    }

    /*
    FinalizeBlockì´ í•˜ëŠ” ì¼:
    - BeginBlock: ë¸”ë¡ ì‹œì‘ ì²˜ë¦¬
    - DeliverTx: ê° íŠ¸ëœì­ì…˜ ì‹¤í–‰ (ìƒíƒœ ë³€ê²½)
    - EndBlock: ë¸”ë¡ ì¢…ë£Œ ì²˜ë¦¬

    ê²°ê³¼ë¡œ ë°›ëŠ” ê²ƒ:
    - TxResults: ê° txì˜ ì‹¤í–‰ ê²°ê³¼ (ì„±ê³µ/ì‹¤íŒ¨)
    - ValidatorUpdates: ê²€ì¦ì ë³€ê²½ ì‚¬í•­
    - AppHash: ìƒíƒœ ë£¨íŠ¸ í•´ì‹œ
    - Events: ë°œìƒí•œ ì´ë²¤íŠ¸ë“¤
    */

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘¡ íŠ¸ëœì­ì…˜ ê²°ê³¼ í™•ì¸
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    failedCount := 0
    for i, txResult := range result.TxResults {
        if txResult.Code != 0 {  // 0ì´ ì•„ë‹ˆë©´ ì‹¤íŒ¨
            e.logger.Printf("Tx %d failed (code=%d): %s", i, txResult.Code, txResult.Log)
            failedCount++
        }
    }
    if failedCount > 0 {
        e.logger.Printf("%d/%d transactions failed", failedCount, len(result.TxResults))
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘¢ ABCI Commit í˜¸ì¶œ
    //    â†’ ìƒíƒœë¥¼ ë””ìŠ¤í¬ì— ì˜êµ¬ ì €ì¥
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    appHash, retainHeight, err := e.abciAdapter.Commit(ctx)
    if err != nil {
        e.logger.Printf("Commit failed: %v", err)
        return
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘£ ì•± í•´ì‹œ ì €ì¥
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    e.mu.Lock()
    e.lastAppHash = result.AppHash
    e.abciAdapter.SetLastAppHash(result.AppHash)
    e.mu.Unlock()

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘¤ ì‹¤í–‰ ì™„ë£Œ í‘œì‹œ
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    state.MarkExecuted()

    // í™•ì •ëœ ë¸”ë¡ ëª©ë¡ì— ì¶”ê°€
    e.mu.Lock()
    e.committedBlocks = append(e.committedBlocks, state.Block)
    e.mu.Unlock()

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘¥ ë©”íŠ¸ë¦­ ê¸°ë¡
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if e.metrics != nil {
        e.metrics.EndConsensusRound(state.SequenceNum)
        e.metrics.SetBlockHeight(state.SequenceNum)
        e.metrics.RecordBlockExecutionTime(time.Since(startTime))
        e.metrics.AddTransactions(len(state.Block.Transactions))
    }

    e.logger.Printf("Executed block at height %d with %d txs, appHash=%x",
        state.SequenceNum, len(state.Block.Transactions), result.AppHash)

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘¦ ê²€ì¦ì ì—…ë°ì´íŠ¸ ì²˜ë¦¬ (ìˆìœ¼ë©´)
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if len(result.ValidatorUpdates) > 0 {
        e.handleValidatorUpdates(result.ValidatorUpdates)
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // â‘§ ì²´í¬í¬ì¸íŠ¸ ìƒì„± (ì£¼ê¸°ì ìœ¼ë¡œ)
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if state.SequenceNum % e.config.CheckpointInterval == 0 {
        e.createCheckpoint(state.SequenceNum)
    }

    _ = appHash
    _ = retainHeight
}
```

**ğŸ” íë¦„ ì •ë¦¬:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   executeBlock() íë¦„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  COMMIT ì¿¼ëŸ¼ ë‹¬ì„± (2f+1)                                     â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘  FinalizeBlock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Cosmos SDK ì•±            â”‚
â”‚           â”‚                              â”‚                   â”‚
â”‚           â”‚                      ê° tx ì‹¤í–‰ (ìƒíƒœ ë³€ê²½)      â”‚
â”‚           â”‚                              â”‚                   â”‚
â”‚           â”‚â—„â”€â”€â”€â”€ TxResults, AppHash â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¡ ì‹¤íŒ¨í•œ tx ë¡œê¹…                                           â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¢ Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Cosmos SDK ì•±            â”‚
â”‚           â”‚                              â”‚                   â”‚
â”‚           â”‚                      ë””ìŠ¤í¬ì— ìƒíƒœ ì €ì¥          â”‚
â”‚           â”‚                              â”‚                   â”‚
â”‚           â”‚â—„â”€â”€â”€â”€ AppHash, RetainHeight â”€â”€â”˜                   â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘£ ì•± í•´ì‹œ ì €ì¥                                             â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¤ state.MarkExecuted()                                     â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¥ ë©”íŠ¸ë¦­ ê¸°ë¡ (TPS, ë¸”ë¡ ì‹œê°„ ë“±)                          â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘¦ ê²€ì¦ì ì—…ë°ì´íŠ¸ (ìˆìœ¼ë©´)                                 â”‚
â”‚           â”‚                                                  â”‚
â”‚           â–¼                                                  â”‚
â”‚  â‘§ ì²´í¬í¬ì¸íŠ¸ (100ë¸”ë¡ë§ˆë‹¤)                                 â”‚
â”‚                                                              â”‚
â”‚  âœ… ë¸”ë¡ ì‹¤í–‰ ì™„ë£Œ!                                          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## STEP 8: View Change (ë¦¬ë” êµì²´)

### ğŸ“ íŒŒì¼: `consensus/pbft/engine_v2.go`

ë¦¬ë”ê°€ ì£½ê±°ë‚˜ ì•…ì˜ì ì´ë©´ View Changeë¡œ ìƒˆ ë¦¬ë”ë¥¼ ì„ ì¶œí•©ë‹ˆë‹¤.

### 8.1 View Change ì‹œì‘ (íƒ€ì„ì•„ì›ƒ)

```go
// ğŸ“ consensus/pbft/engine_v2.go:669-691

// startViewChange - íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¸í•œ View Change ì‹œì‘
func (e *EngineV2) startViewChange() {
    e.mu.Lock()
    newView := e.view + 1           // ë‹¤ìŒ ë·°ë¡œ (ìƒˆ ë¦¬ë”)
    lastSeqNum := e.sequenceNum     // í˜„ì¬ê¹Œì§€ì˜ ë§ˆì§€ë§‰ ì‹œí€€ìŠ¤
    e.mu.Unlock()

    e.logger.Printf("Starting view change to view %d (timeout)", newView)

    if e.metrics != nil {
        e.metrics.IncrementViewChanges()
    }

    // ì²´í¬í¬ì¸íŠ¸ì™€ Prepared ì¸ì¦ì„œ ìˆ˜ì§‘
    checkpoints := e.collectCheckpoints()
    preparedSet := e.collectPreparedCertificates()

    // ViewChangeManagerì—ê²Œ ì²˜ë¦¬ ìœ„ì„
    e.viewChangeManager.StartViewChange(newView, lastSeqNum, checkpoints, preparedSet)

    // ìƒˆ íƒ€ì´ë¨¸ ì„¤ì • (ì´ë²ˆì—ë„ ì‹¤íŒ¨í•˜ë©´ ë‹¤ì‹œ View Change)
    e.mu.Lock()
    e.viewChangeTimer = time.AfterFunc(e.config.ViewChangeTimeout*2, func() {
        e.startViewChange()  // ì¬ê·€ì ìœ¼ë¡œ ë‹¤ì‹œ ì‹œì‘
    })
    e.mu.Unlock()
}
```

### 8.2 View Change íƒ€ì´ë¨¸ ë¦¬ì…‹

```go
// ğŸ“ consensus/pbft/engine_v2.go:763-770

// resetViewChangeTimer - íƒ€ì´ë¨¸ ë¦¬ì…‹ (ë¦¬ë”ê°€ ì‚´ì•„ìˆë‹¤ëŠ” ì¦ê±°)
func (e *EngineV2) resetViewChangeTimer() {
    if e.viewChangeTimer != nil {
        e.viewChangeTimer.Stop()  // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ì§€
    }

    // ìƒˆ íƒ€ì´ë¨¸ ì„¤ì •
    e.viewChangeTimer = time.AfterFunc(e.config.ViewChangeTimeout, func() {
        e.startViewChange()  // íƒ€ì„ì•„ì›ƒë˜ë©´ View Change!
    })
}
```

**ğŸ” View Changeê°€ ì¼ì–´ë‚˜ëŠ” ìƒí™©:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  View Change íŠ¸ë¦¬ê±° ì¡°ê±´                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. íƒ€ì„ì•„ì›ƒ (ViewChangeTimeout ë‚´ì— ë¸”ë¡ ì§„í–‰ ì—†ìŒ)        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚     â”‚  ì‹œê°„ì´ ì§€ë‚¬ëŠ”ë° ìƒˆ ë¸”ë¡ì´ ì•ˆ ì™€ìš”...    â”‚              â”‚
â”‚     â”‚  â†’ ë¦¬ë”ê°€ ì£½ì—ˆë‚˜? View Change!          â”‚              â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                              â”‚
â”‚  2. ë¦¬ë”ê°€ ì˜ëª»ëœ ë¸”ë¡ ì œì•ˆ                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚     â”‚  ProcessProposalì—ì„œ REJECT ë°›ìŒ        â”‚              â”‚
â”‚     â”‚  â†’ ë¦¬ë”ê°€ ì•…ì˜ì ? View Change!          â”‚              â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                              â”‚
â”‚  3. 2f+1 ë…¸ë“œê°€ View Change ìš”ì²­                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚     â”‚  ë‹¤ìˆ˜ê°€ ë¦¬ë” êµì²´ë¥¼ ì›í•¨                â”‚              â”‚
â”‚     â”‚  â†’ ìƒˆ ë¦¬ë” ì„ ì¶œ!                        â”‚              â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ” View Change íë¦„:**

```
view=0 (ë¦¬ë”: Node0)              view=1 (ë¦¬ë”: Node1)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
          â”‚                              â”‚
          â”‚  íƒ€ì„ì•„ì›ƒ!                    â”‚
          â”‚                              â”‚
          â–¼                              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
  â”‚ VIEW-CHANGE   â”‚                      â”‚
  â”‚ (v=1 ìš”ì²­)    â”‚                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
          â”‚                              â”‚
          â”‚  2f+1 ë…¸ë“œê°€ VIEW-CHANGE ì „ì†¡â”‚
          â”‚                              â”‚
          â–¼                              â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
  â”‚ Node1ì´       â”‚                      â”‚
  â”‚ NEW-VIEW ì „ì†¡ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
                                         â”‚
                                         â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ ìƒˆ ë¦¬ë”ë¡œ     â”‚
                                 â”‚ í•©ì˜ ì¬ê°œ     â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í•µì‹¬ ìë£Œêµ¬ì¡° í•´ì„¤

### ğŸ“ íŒŒì¼: `consensus/pbft/state.go`

### State êµ¬ì¡°ì²´

```go
// ğŸ“ consensus/pbft/state.go

// State - íŠ¹ì • ì‹œí€€ìŠ¤ ë²ˆí˜¸ì˜ í•©ì˜ ìƒíƒœ
type State struct {
    mu sync.RWMutex

    View        uint64      // ë·° ë²ˆí˜¸
    SequenceNum uint64      // ì‹œí€€ìŠ¤ ë²ˆí˜¸ (= ë¸”ë¡ ë†’ì´)
    Phase       StatePhase  // í˜„ì¬ ë‹¨ê³„

    // ë©”ì‹œì§€ ì €ì¥
    PrePrepareMsg *PrePrepareMsg           // ë¦¬ë”ê°€ ë³´ë‚¸ PrePrepare
    PrepareMsgs   map[string]*PrepareMsg   // ê° ë…¸ë“œì˜ Prepare (nodeID -> msg)
    CommitMsgs    map[string]*CommitMsg    // ê° ë…¸ë“œì˜ Commit (nodeID -> msg)

    Block *types.Block  // ì œì•ˆëœ ë¸”ë¡

    Executed bool  // ì‹¤í–‰ ì™„ë£Œ ì—¬ë¶€
}

// StatePhase - í•©ì˜ ë‹¨ê³„
type StatePhase int

const (
    Idle        StatePhase = iota  // 0: ì´ˆê¸° ìƒíƒœ
    PrePrepared                    // 1: PrePrepare ë°›ìŒ
    Prepared                       // 2: 2f+1 Prepare ë°›ìŒ
    Committed                      // 3: 2f+1 Commit ë°›ìŒ
)
```

**ğŸ” ìƒíƒœ ì „ì´ ë‹¤ì´ì–´ê·¸ë¨:**

```
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Idle  â”‚  â—„â”€â”€ ì´ˆê¸° ìƒíƒœ (ì•„ë¬´ê²ƒë„ ì—†ìŒ)
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
          â”‚
          â”‚ PrePrepare ìˆ˜ì‹  + ProcessProposal ACCEPT
          â”‚
          â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚PrePreparedâ”‚  â—„â”€â”€ PrePrepare ì €ì¥ë¨
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ PrepareCount >= 2f+1
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Prepared  â”‚  â—„â”€â”€ PREPARE ì¿¼ëŸ¼ ë‹¬ì„±
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ CommitCount >= 2f+1
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Committed â”‚  â—„â”€â”€ COMMIT ì¿¼ëŸ¼ ë‹¬ì„±
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ executeBlock() í˜¸ì¶œ
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Executed  â”‚  â—„â”€â”€ ë¸”ë¡ ì‹¤í–‰ ì™„ë£Œ âœ…
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ íŒŒì¼: `consensus/pbft/messages.go`

### Message êµ¬ì¡°ì²´ë“¤

```go
// ğŸ“ consensus/pbft/messages.go

// Message - ë„¤íŠ¸ì›Œí¬ë¡œ ì „ì†¡ë˜ëŠ” PBFT ë©”ì‹œì§€
type Message struct {
    Type        MessageType `json:"type"`         // ë©”ì‹œì§€ ì¢…ë¥˜
    View        uint64      `json:"view"`         // ë·° ë²ˆí˜¸
    SequenceNum uint64      `json:"sequence_num"` // ì‹œí€€ìŠ¤ ë²ˆí˜¸
    Digest      []byte      `json:"digest"`       // ë¸”ë¡ í•´ì‹œ
    NodeID      string      `json:"node_id"`      // ë³´ë‚¸ ë…¸ë“œ ID
    Timestamp   time.Time   `json:"timestamp"`    // íƒ€ì„ìŠ¤íƒ¬í”„
    Signature   []byte      `json:"signature"`    // ì„œëª…
    Payload     []byte      `json:"payload"`      // ì‹¤ì œ ë°ì´í„° (JSON)
}

// PrePrepareMsg - ë¦¬ë”ê°€ ë³´ë‚´ëŠ” ë¸”ë¡ ì œì•ˆ
type PrePrepareMsg struct {
    View        uint64       `json:"view"`
    SequenceNum uint64       `json:"sequence_num"`
    Digest      []byte       `json:"digest"`       // ë¸”ë¡ í•´ì‹œ
    Block       *types.Block `json:"block"`        // ì „ì²´ ë¸”ë¡!
    PrimaryID   string       `json:"primary_id"`   // ë¦¬ë” ID
}

// PrepareMsg - "ë‚˜ëŠ” ì´ ë¸”ë¡ì— ë™ì˜í•´"
type PrepareMsg struct {
    View        uint64 `json:"view"`
    SequenceNum uint64 `json:"sequence_num"`
    Digest      []byte `json:"digest"`       // ë™ì˜í•˜ëŠ” ë¸”ë¡ì˜ í•´ì‹œ
    NodeID      string `json:"node_id"`      // ë‚´ ID
}

// CommitMsg - "ì»¤ë°‹í•  ì¤€ë¹„ ëì–´"
type CommitMsg struct {
    View        uint64 `json:"view"`
    SequenceNum uint64 `json:"sequence_num"`
    Digest      []byte `json:"digest"`
    NodeID      string `json:"node_id"`
}
```

---

## ì „ì²´ íë¦„ í•œëˆˆì— ë³´ê¸°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              PBFT í•©ì˜ ì „ì²´ íë¦„                                     â”‚
â”‚                                                                                      â”‚
â”‚  ì‹œê°„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                    â”‚
â”‚  â”‚   Client    â”‚                                                                    â”‚
â”‚  â”‚  íŠ¸ëœì­ì…˜   â”‚                                                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                                    â”‚
â”‚         â”‚                                                                           â”‚
â”‚         â”‚ â‘  SubmitTx                                                               â”‚
â”‚         â–¼                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                    â”‚
â”‚  â”‚   Mempool   â”‚  â† íŠ¸ëœì­ì…˜ ì €ì¥, CheckTx ê²€ì¦                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                                    â”‚
â”‚         â”‚                                                                           â”‚
â”‚         â”‚ â‘¡ ReapMaxTxs (Primaryë§Œ)                                                 â”‚
â”‚         â–¼                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Primary    â”‚     â”‚  Replica1   â”‚     â”‚  Replica2   â”‚     â”‚  Replica3   â”‚       â”‚
â”‚  â”‚   (Node0)   â”‚     â”‚  (Node1)    â”‚     â”‚  (Node2)    â”‚     â”‚  (Node3)    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚ â‘¢ PrepareProposal (ABCI)              â”‚                   â”‚              â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚              â”‚
â”‚         â”‚              PRE-PREPARE (ë¸”ë¡ ì œì•ˆ)                      â”‚              â”‚
â”‚         â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚              â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚                   â”‚ â‘£ ProcessProposal (ABCI)              â”‚              â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚              â”‚
â”‚         â”‚                  PREPARE (ë™ì˜ íˆ¬í‘œ)                      â”‚              â”‚
â”‚         â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚              â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚          â‘¤ 2f+1 PREPARE ìˆ˜ì§‘ (ì¿¼ëŸ¼)                       â”‚              â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚              â”‚
â”‚         â”‚                   COMMIT (ì»¤ë°‹ íˆ¬í‘œ)                      â”‚              â”‚
â”‚         â”‚â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚              â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚          â‘¥ 2f+1 COMMIT ìˆ˜ì§‘ (ì¿¼ëŸ¼)                        â”‚              â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚ â‘¦ FinalizeBlock  â”‚ FinalizeBlock     â”‚ FinalizeBlock     â”‚              â”‚
â”‚         â”‚    (ABCI)        â”‚    (ABCI)         â”‚    (ABCI)         â”‚              â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â”‚ â‘§ Commit (ABCI)  â”‚ Commit (ABCI)     â”‚ Commit (ABCI)     â”‚              â”‚
â”‚         â”‚                   â”‚                   â”‚                   â”‚              â”‚
â”‚         â–¼                   â–¼                   â–¼                   â–¼              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         ë¸”ë¡ ì»¤ë°‹ ì™„ë£Œ! ë‹¤ìŒ ë¸”ë¡ìœ¼ë¡œ...                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì½”ë“œ ì½ëŠ” ìˆœì„œ ì¶”ì²œ

1. **`mempool/tx.go`** - Tx êµ¬ì¡°ì²´ ì´í•´
2. **`mempool/mempool.go`** - AddTx, ReapMaxTxs ì´í•´
3. **`consensus/pbft/messages.go`** - ë©”ì‹œì§€ íƒ€ì…ë“¤ ì´í•´
4. **`consensus/pbft/state.go`** - State, StatePhase ì´í•´
5. **`consensus/pbft/engine_v2.go`** - ë©”ì¸ ë¡œì§!
   - `run()` - ë©”ì¸ ë£¨í”„
   - `proposeBlock()` - PRE-PREPARE
   - `handlePrePrepare()` - PRE-PREPARE ì²˜ë¦¬
   - `handlePrepare()` - PREPARE ì²˜ë¦¬
   - `handleCommit()` - COMMIT ì²˜ë¦¬
   - `executeBlock()` - ë¸”ë¡ ì‹¤í–‰
6. **`consensus/pbft/abci_adapter.go`** - Cosmos SDK ì—°ê²°

---

## ë””ë²„ê¹… íŒ

ë¡œê·¸ë¥¼ ë³´ë©´ì„œ íë¦„ì„ ë”°ë¼ê°€ì„¸ìš”:

```bash
# ë¡œê·¸ ì˜ˆì‹œ
[PBFT-V2] Primary broadcast PRE-PREPARE for seq 1    # â‘  ë¦¬ë”ê°€ ë¸”ë¡ ì œì•ˆ
[PBFT-V2] Node node1 sent PREPARE for seq 1          # â‘¡ PREPARE íˆ¬í‘œ
[PBFT-V2] Node node1 PREPARED and sent COMMIT        # â‘¢ ì¿¼ëŸ¼ ë‹¬ì„±, COMMIT íˆ¬í‘œ
[PBFT-V2] Node node1 COMMITTED seq 1                 # â‘£ COMMIT ì¿¼ëŸ¼ ë‹¬ì„±
[PBFT-V2] Executed block at height 1 with 5 txs      # â‘¤ ë¸”ë¡ ì‹¤í–‰ ì™„ë£Œ!
```

---

## ìì£¼ ë¬»ëŠ” ì§ˆë¬¸

### Q1: ì™œ 2f+1 ê°œì˜ ë™ì˜ê°€ í•„ìš”í•œê°€ìš”?

```
A: ë¹„ì”í‹´ ì¥ì• ë¥¼ ê²¬ë””ê¸° ìœ„í•´ì„œì…ë‹ˆë‹¤.

n = 3f + 1 (ì´ ë…¸ë“œ ìˆ˜)
- fê°œì˜ ì•…ì˜ì  ë…¸ë“œê°€ ìˆì–´ë„ ë™ì‘í•´ì•¼ í•¨
- 2f + 1ê°œê°€ ë™ì˜í•˜ë©´, ìµœì†Œ f + 1ê°œì˜ ì •ì§í•œ ë…¸ë“œê°€ ë™ì˜í•œ ê²ƒ
- ì •ì§í•œ ë…¸ë“œê°€ ê³¼ë°˜ì´ë¯€ë¡œ ì•ˆì „!

ì˜ˆ: 4ë…¸ë“œ (f=1)
- 1ê°œê°€ ì•…ì˜ì ì´ì–´ë„ 3ê°œê°€ ë™ì˜í•˜ë©´ OK
- 3ê°œ ì¤‘ ìµœì†Œ 2ê°œëŠ” ì •ì§í•œ ë…¸ë“œ
```

### Q2: View ChangeëŠ” ì™œ í•„ìš”í•œê°€ìš”?

```
A: ë¦¬ë”ê°€ ì£½ê±°ë‚˜ ì•…ì˜ì ì¼ ë•Œ ì‹œìŠ¤í…œì´ ë©ˆì¶”ì§€ ì•Šë„ë¡!

- ë¦¬ë”ê°€ ë¸”ë¡ì„ ì•ˆ ë³´ë‚´ë©´? â†’ íƒ€ì„ì•„ì›ƒ í›„ View Change
- ë¦¬ë”ê°€ ì˜ëª»ëœ ë¸”ë¡ì„ ë³´ë‚´ë©´? â†’ ProcessProposal REJECT í›„ View Change
- ìƒˆ View = ìƒˆ ë¦¬ë” ì„ ì¶œ
```

### Q3: Mempoolì€ ì™œ í•„ìš”í•œê°€ìš”?

```
A: ë¸”ë¡ì— í¬í•¨ë˜ê¸° ì „ íŠ¸ëœì­ì…˜ì„ ì„ì‹œ ë³´ê´€í•˜ëŠ” ëŒ€ê¸°ì‹¤!

- í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ txë¥¼ ì¦‰ì‹œ ì €ì¥
- ë¦¬ë”ê°€ ë¸”ë¡ ë§Œë“¤ ë•Œ ì—¬ê¸°ì„œ txë¥¼ ê°€ì ¸ê°
- ì¤‘ë³µ ë°©ì§€, ìš°ì„ ìˆœìœ„ ì •ë ¬, ìš©ëŸ‰ ê´€ë¦¬ ë“±
```

---

Happy Coding! ğŸš€
